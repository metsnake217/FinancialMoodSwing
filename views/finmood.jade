    
extends layoutmood

block content

    div(class="container", style="min-height: 634px;")
        //a(href="/mood")
            //img(src="/images/spot.png" width="5%", class="logofin1")
        //a(href="/login")
            //img(src="/images/test1.png" class="logofin")
        //div(class="checkboxThree")
                        //input(type="checkbox" name="manualprog" id="manualprog" value="prog" checked)
                        //label(for="manualprog" class="labelcheck shadow")
        div(style="display:block;margin: 0 auto; text-align:center;padding:40px;    padding-top: 15%;color: black;")
            h1(style="font-size: 40px;")!= "Mood Swing"
            p!= "Select a stock option to set the mood."
            form(id="playlistedit-form")
                div(id="playlistedit")
                    script(id="playlistedit-template" type="text/x-handlebars-template")
                        <select name="playeditmood" type="text" id="playeditmood" class="form-control form-controlfin" style="" placeholder="Select Portfolio">
                        <option value="select portfolio">Select Portfolio Stock</option><option value="all">All Portfolio</option>{{#each this}}<option value="{{symbol}}">{{name}}</option>{{/each}}</select>
                        <span style="color: #8a6d3b;float: right;top: -38px;right: 2.5%;position: relative;font-size: 14pt;" class="fa fa-sort"></span>
            div(id="stock" style="display:none;margin-top: 30px")
                    script(id="stock-template" type="text/x-handlebars-template")
                        <span style="font-size: 18pt;margin-right:10px"><span style="color: #00bc00;">stock: </span>{{index}}<span style="font-size:8pt">{{desc}}</span><span class="{{getClass diff}}">{{diff}}</span></span><img src="/images/fin{{mood}}.png" width="31px" height="31px"/><img src="/images/vol{{mood}}.gif" trackurl="{{url}}" width="150px" height="75px" class="stocknote animated zoomInUp /* tada infinite*/"/><!--<div id="player" style="position: absolute; top: -9999px; left: -9999px;"></div>-->
            div(id="stocknodata" style="display:none;margin-top: 30px")
                    
        br(style="clear: both;")

    script.
        Handlebars.registerHelper('getWidth', function(passedString) {
        console.log("before getWidth");
            var widthString = "30px";
            if(passedString == "mode_waydown" || passedString == "mode_wayup"){
                widthString = "20px";
            } 
            console.log("widthString is: " + widthString);
            return new Handlebars.SafeString(widthString)
        });
        Handlebars.registerHelper('getClass', function(passedString) {
        console.log("before getWidth");
            var intstring = passedString;
            var classname = "tickerpos";
            if(intstring <= 0){
               classname = "tickerneg";
            } 
            console.log("intstring is: " + intstring);
            return new Handlebars.SafeString(classname)
        });
        var bearer = "Bearer " + "#{access_token}";
        var user;
        var playList = [];
        var templateSourceplayedit = document.getElementById('playlistedit-template').innerHTML,
            templateedit = Handlebars.compile(templateSourceplayedit),
            editPlaceholder = document.getElementById('playlistedit');
        var templateSourceStock = document.getElementById('stock-template').innerHTML,
            templatestock = Handlebars.compile(templateSourceStock),
            stockPlaceholder = document.getElementById('stock');

        var audioObject;

        var searchPlaylists = function () {
            var player;
            console.log("looking for playlists");
            console.log("access token in playlists: " + bearer);
            $.ajax({
                //url: 'https://api.spotify.com/v1/me/playlists',
                url: 'https://financialmoodswing.herokuapp.com/stocksfetch',
                headers: {'Access-Control-Allow-Origin': '*','Access-Control-Allow-Methods': 'POST,GET,PUT,DELETE','Access-Control-Allow-Headers': 'Authorization, Lang'},
                success: function (response) {
                    editPlaceholder.innerHTML = templateedit(response.res);
                    console.log("success get portfolio.");
                    console.dir(response.res);
                    $( "#playeditmood" ).change(function() {

                        var prog = 0;
                        var check = $("#manualprog:checked").val();
                        console.log("check is: " + check);
                        if(check == undefined){
                            prog = 1;
                        }
                        
                        if(audioObject){
                        audioObject.pause();
                        }

                        var playlistid = $(this).val();
                        var playstr = "'" + playlistid + "'";
                        console.log("stock symbol: " + playlistid);
                        var listname = "test2";//$("#playeditmood option[value=" + playstr + "]").text();
                        console.log("listname: " + listname);
                        if(listname !="Select Portfolio"){

                        $.ajax({
                            url: 'https://financialmoodswing.herokuapp.com/stockfetchfinmood',
                            headers: {'Access-Control-Allow-Origin': '*','Access-Control-Allow-Methods': 'POST,GET,PUT,DELETE','Access-Control-Allow-Headers': 'Authorization, Lang'},
                            data: {playlistname: listname, prog: prog, stocksymbol: playlistid},
                            success: function (response) {
                            console.log("response nodata?: " + response);
                            console.dir(response);
                                if(response != "nodata"){
                                stockPlaceholder.innerHTML = templatestock(response);
                                $("#stocknodata").hide();
                                $("#stock").show();
                                console.log("success got stocks: " + response);
                                console.dir(response);
                                var preview = response.url;
                                var youtubeid = response.youtube;
                                $("#stocknote").show();

                                var info = document.getElementById('info');

                                $(window).scrollTop($('#stock').offset().top).scrollLeft($('#stock').offset().left);
                                audioObject = new Audio(preview);
                                audioObject.play();
                                console.dir(audioObject);

                                audioObject.onpause=function(){
                                console.log("audio paused");
                                $(".stocknote").hide();
                                $("#stock").css("margin-top","65px");
                                };
                                $( ".stocknote" ).click(function() {
                                    //if(audioObject){
                                    //    audioObject.pause();
                                   // }
                                    //$("#playeditmood").val("select playlist");
                                    //$( ".stocknote" ).removeClass("lightSpeedIn");
                                    //$( ".stocknote" ).addClass("lightSpeedOut");
                                    //$( ".stocknote" ).hide();

                                });
                                $( ".stocknote" ).click(function() {

                                    if(audioObject.paused){
                                        audioObject.play();
                                    } else {
                                        audioObject.pause();
                                        $( ".stocknote" ).hide();
                                        $("#playeditmood").val("select portfolio");
                                    }
                                    //$("#playeditmood").val("select playlist");
                                    //$( ".stocknote" ).removeClass("lightSpeedIn");
                                    //$( ".stocknote" ).addClass("lightSpeedOut");
                                    

                                });

                                //function onYouTubePlayerAPIReady() {
                                /*    console.log("youtube player");
                                   player = new YT.Player('player', {
                                      videoId: youtubeid,
                                      loop: false,
                                      autoplay:true,
                                      playsinline: 1,
                                      events: {
                                          onReady: function (e) {
                                            console.log("now playing");
                                              
                                              e.target.playVideo();
                                          },
                                          onStateChange: function (event) {
                                              if (event.data === 1) {
                                                console.log("started");
                                                 playing';
                                              }
                                          }
                                      }
                                  });*/

                                  // you can do more stuff with the player variable
                                 /* $( ".stocknote" ).click(function() {
                                  console.log("player state: " + player.getPlayerState());
                                    if(player.getPlayerState() == YT.PlayerState.PLAYING){
                                        player.stopVideo();
                                        console.log("now stopping video");
                                        $( ".stocknote" ).hide();
                                        $("#playeditmood").val("select playlist");
                                    } else if(player.getPlayerState() == YT.PlayerState.BUFFERING){
                                        player.playVideo();
                                    } else{
                                        player.playVideo();
                                    }
                                  });*/
                                //}

                            } else {
                                $("#stock").hide();
                                $("#stocknodata").show();
                                $("#stocknodata").html("No data could be fetched for this stock option.");
                            }

                            }
                        });
                        } else {
                        $("#stock").hide();

                        }
                    });
                }
            });
        };
        searchPlaylists();

        function isPlaying(audelem) { return !audelem.paused; }


