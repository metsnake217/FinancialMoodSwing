    
extends layout

block content

    div(class="container")
        h1!= "Search for an Artist"
        p!= "Type an artist name and click on 'Search'. Then, click on any album from the results to play 30 seconds of its first track."
        form(id="search-form")
            input(type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name")
            input(type="submit" id="search" class="btn btn-primary" value="Search")
        div(id="results")
        script(id="results-template" type="text/x-handlebars-template")
            {{#each albums.items}}
            <div style="/*background-image:url({{images.0.url}})*/" data-album-id="{{id}}" class="cover"><img src="{{images.0.url}}" width="100px" height="100px"/></div>
            {{/each}}

    script.
        var bearer = "Bearer " + "#{access_token}";
        // find template and compile it
        var templateSource = document.getElementById('results-template').innerHTML,
            template = Handlebars.compile(templateSource),
            resultsPlaceholder = document.getElementById('results'),
            playingCssClass = 'playing',
            noplayingClass = "cannotplay",
            audioObject = null;

        var fetchTracks = function (albumId, callback) {
            $.ajax({
                url: 'https://api.spotify.com/v1/albums/' + albumId,
                headers: {'Authorization': bearer},
                success: function (response) {
                    callback(response);
                }
            });
        };

        var searchAlbums = function (query) {
            console.log("access: " + bearer);
            $.ajax({
                url: 'https://api.spotify.com/v1/search',
                headers: {'Authorization': bearer},
                data: {
                    q: query,
                    type: 'album'
                },
                success: function (response) {
                    resultsPlaceholder.innerHTML = template(response);
                }
            });
        };

        results.addEventListener('click', function (e) {
            var target = e.target;
            if (target !== null && target.classList.contains('cover')) {
                if (target.classList.contains(playingCssClass)) {
                    audioObject.pause();
                } else {
                    if (audioObject) {
                        audioObject.pause();
                    }
                    fetchTracks(target.getAttribute('data-album-id'), function (data) {
                        var preview = data.tracks.items[0].preview_url;
                        //if(preview != null){
                        audioObject = new Audio(preview);
                        audioObject.play();
                        target.classList.add(playingCssClass);
                        audioObject.addEventListener('ended', function () {
                            target.classList.remove(playingCssClass);
                        });
                        audioObject.addEventListener('pause', function () {
                            target.classList.remove(playingCssClass);
                        });
                        //} else {
                         //   target.classList.add(noplayingClass);
                        //}
                    });
                }
            }
        });

        document.getElementById('search-form').addEventListener('submit', function (e) {
            e.preventDefault();
            searchAlbums(document.getElementById('query').value);
        }, false);